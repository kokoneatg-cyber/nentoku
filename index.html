<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>年間特別費（Firestore版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    .year-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #ffffff;
    }

    .top-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 16px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary-item-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .summary-item-value {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .summary-item-percent {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .percent-bar {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-top: 4px;
      overflow: hidden;
    }

    .percent-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: #60a5fa;
      transition: width 0.3s ease;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      border-left: 4px solid #3b82f6;
      padding-left: 8px;
      margin: 16px 0 8px;
    }

    .category-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .category-name {
      font-weight: 600;
    }

    .category-numbers {
      display: grid;
      grid-template-columns: repeat(3, auto);
      gap: 12px;
      font-size: 0.85rem;
    }

    .category-numbers span {
      white-space: nowrap;
    }

    .category-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .category-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn-primary {
      background: #3b82f6;
      color: #ffffff;
    }

    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-xs {
      padding: 2px 6px;
      font-size: 0.7rem;
      border-radius: 999px;
    }

    button:active {
      transform: translateY(1px);
    }

    .add-category-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .add-category-form input {
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }

    .add-form {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
    }

    .add-form-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }

    .add-form-row input {
      width: 100%;
      padding: 4px 6px;
      font-size: 0.8rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }

    .add-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    details {
      margin-top: 6px;
      font-size: 0.85rem;
    }

    details summary {
      cursor: pointer;
      list-style: none;
      outline: none;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary::before {
      content: "▶ ";
      font-size: 0.7rem;
    }

    details[open] summary::before {
      content: "▼ ";
    }

    .transaction-list {
      margin-top: 4px;
      padding-left: 10px;
    }

    .transaction-item {
      padding: 2px 0;
      border-bottom: 1px dashed #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .transaction-text {
      flex: 1;
      min-width: 0;
      display: grid;
      grid-template-columns: 70px 90px 1fr 120px; /* 日付 / 金額 / 内容 / 店舗 */
      column-gap: 8px;
      font-size: 0.85rem;
      font-variant-numeric: tabular-nums;
    }

    .transaction-text span {
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .transaction-empty {
      color: #9ca3af;
      font-style: italic;
      padding: 4px 0;
    }

    .badge-percent {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .text-danger {
      color: #b91c1c;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 640px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      .category-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .category-numbers {
        grid-template-columns: 1fr;
      }
      .add-form-row {
        grid-template-columns: 1fr 1fr;
      }
      .transaction-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .transaction-text {
        grid-template-columns: 70px 90px;
        grid-auto-rows: auto;
        row-gap: 2px;
      }
      .add-category-form {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-row">
      <h1>年間特別費</h1>
      <div class="top-actions">
        <button id="export-csv-btn" class="btn-outline">支出CSVダウンロード</button>
        <button id="import-csv-btn" class="btn-primary">支出CSVインポート</button>
      </div>
    </div>

    <div class="year-row">
      <label for="fiscal-year-select">年度（4月〜翌年3月）：</label>
      <select id="fiscal-year-select"></select>
      <button id="reload-btn" class="btn-outline btn-xs">再読み込み</button>
      <button id="new-year-btn" class="btn-primary btn-xs">新年度作成</button>
    </div>

    <div class="card">
      <div class="summary-grid">
        <div>
          <div class="summary-item-label">予算</div>
          <div class="summary-item-value" id="total-budget">0円</div>
        </div>
        <div>
          <div class="summary-item-label">残高</div>
          <div class="summary-item-value" id="total-remaining">0円</div>
        </div>
        <div>
          <div class="summary-item-label">使用率</div>
          <div class="summary-item-percent" id="total-percent">0%</div>
          <div class="percent-bar">
            <div class="percent-bar-fill" id="total-percent-bar"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="section-title">費目</div>
    <div class="card">
      <form id="add-category-form" class="add-category-form">
        <input type="text" id="new-category-name" placeholder="費目名（例：洋服）" required />
        <input type="number" id="new-category-budget" placeholder="予算額" min="0" required />
        <button type="submit" class="btn-primary">費目を追加</button>
      </form>
      <div id="categories-tools-note" style="font-size:0.8rem;color:#6b7280;margin-bottom:4px;">
        費目名・予算額はあとから編集／削除できます。
      </div>
    </div>

    <div id="categories-container">
      <!-- 費目カードがここに描画されます -->
    </div>

    <!-- CSVインポート用ファイル入力（非表示） -->
    <input type="file" id="csv-file-input" accept=".csv,text/tab-separated-values,text/plain" class="hidden" />
  </div>

  <script type="module">
    // ==========================
    // Firebase 初期化
    // ==========================
/* Firebase App */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

/* Firestore 基本 */
import {
  getFirestore,
  collection,
  doc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* Firestore 読み取り */
import {
  getDocs,
  query,
  where,
  orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-read.js";

/* Firestore 書き込み */
import {
  addDoc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-write.js";


    // ★★★ ここをあなたの firebaseConfig に置き換えてください ★★★
    const firebaseConfig = {
      apiKey: "AIzaSyA7UqsmHTLIr15y7I2TJFMk1xqrSBl4P2g",
      authDomain: "nentoku-3869f.firebaseapp.com",
      projectId: "nentoku-3869f",
      storageBucket: "nentoku-3869f.firebasestorage.app",
      messagingSenderId: "153031673000",
      appId: "1:153031673000:web:87b805c4f2ca1ea7cf6e9d"
    };
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==========================
    // 状態
    // ==========================
    const state = {
      fiscalYears: [],
      currentFiscalYear: null,
      categories: [],   // [{id, name, budget, order, fiscalYear}]
      transactions: []  // [{id, categoryId, date, shop, description, amount, fiscalYear}]
    };

    // ==========================
    // ユーティリティ
    // ==========================
    function formatYen(num) {
      return num.toLocaleString("ja-JP") + "円";
    }

    function formatDateForView(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr || "";
      return d.toLocaleDateString("ja-JP", { month: "numeric", day: "numeric" }); // 5/5
    }

    // 4月始まりの年度を計算
    function calcFiscalYear(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return null;
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      return m >= 4 ? y : y - 1;
    }

    function calcCategory(cat) {
      const used = state.transactions
        .filter((t) => t.categoryId === cat.id)
        .reduce((sum, t) => sum + (t.amount || 0), 0);
      const remaining = cat.budget - used;
      const percent = cat.budget > 0 ? Math.min(100, (used / cat.budget) * 100) : 0;
      return { used, remaining, percent };
    }

    function calcTotal() {
      let totalBudget = 0;
      let totalUsed = 0;
      state.categories.forEach((cat) => {
        const { used } = calcCategory(cat);
        totalBudget += cat.budget;
        totalUsed += used;
      });
      const totalRemaining = totalBudget - totalUsed;
      const percent = totalBudget > 0 ? Math.min(100, (totalUsed / totalBudget) * 100) : 0;
      return { totalBudget, totalRemaining, percent };
    }

    function getPercentBadgeClass(percent) {
      if (percent >= 100) return "badge-percent badge-danger";
      if (percent >= 80) return "badge-percent badge-warning";
      return "badge-percent";
    }

    function getNowFiscalYear() {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth() + 1;
      return m >= 4 ? y : y - 1;
    }

    // ==========================
    // Firestore 読み込み
    // ==========================
    async function loadFiscalYearsFromCategories() {
      const snap = await getDocs(collection(db, "categories"));
      const yearsSet = new Set();
      snap.forEach((doc) => {
        const data = doc.data();
        if (typeof data.fiscalYear === "number") {
          yearsSet.add(data.fiscalYear);
        }
      });
      let years = Array.from(yearsSet);
      if (years.length === 0) {
        // データがまだない場合は現在の年度だけ用意
        years = [getNowFiscalYear()];
      }
      years.sort((a, b) => a - b);
      state.fiscalYears = years;
      state.currentFiscalYear = years[years.length - 1];
    }

    async function loadDataForFiscalYear(fiscalYear) {
      // --- 費目 ---
      const catRef = collection(db, "categories");
      const catQuery = query(
        catRef,
        where("fiscalYear", "==", fiscalYear),
        orderBy("order", "asc")
      );
      const catSnap = await getDocs(catQuery);
      const categories = [];
      catSnap.forEach((d) => {
        const data = d.data();
        categories.push({
          id: d.id,
          name: data.name,
          budget: data.budget ?? 0,
          order: data.order ?? 0,
          fiscalYear: data.fiscalYear
        });
      });

      // --- 支出 ---
      const tranRef = collection(db, "transactions");
      const tranQuery = query(
        tranRef,
        where("fiscalYear", "==", fiscalYear),
        orderBy("date", "asc")
      );
      const tranSnap = await getDocs(tranQuery);
      const transactions = [];
      tranSnap.forEach((d) => {
        const data = d.data();
        transactions.push({
          id: d.id,
          categoryId: data.categoryId,
          date: data.date,
          shop: data.shop ?? "",
          description: data.description ?? "",
          amount: data.amount ?? 0,
          fiscalYear: data.fiscalYear
        });
      });

      state.categories = categories;
      state.transactions = transactions;
      renderAll();
    }

    // ==========================
    // Firestore 書き込み系
    // ==========================
    async function addCategory(name, budget) {
      const fiscalYear = state.currentFiscalYear;
      const nowOrder = state.categories.length > 0
        ? Math.max(...state.categories.map((c) => c.order ?? 0)) + 1
        : 1;
      await addDoc(collection(db, "categories"), {
        name,
        budget,
        order: nowOrder,
        fiscalYear
      });
      await loadDataForFiscalYear(fiscalYear);
    }

    async function updateCategory(catId, newName, newBudget) {
      const ref = doc(db, "categories", catId);
      await updateDoc(ref, {
        name: newName,
        budget: newBudget
      });
      await loadDataForFiscalYear(state.currentFiscalYear);
    }

    async function deleteCategoryAndTransactions(catId) {
      const ok = confirm("この費目と、その費目に紐づくすべての支出を削除します。よろしいですか？");
      if (!ok) return;

      // 支出の削除
      const tranRef = collection(db, "transactions");
      const tranQuery = query(tranRef, where("categoryId", "==", catId));
      const tranSnap = await getDocs(tranQuery);
      const deletePromises = [];
      tranSnap.forEach((d) => {
        deletePromises.push(deleteDoc(doc(db, "transactions", d.id)));
      });
      await Promise.all(deletePromises);

      // 費目の削除
      await deleteDoc(doc(db, "categories", catId));
      await loadDataForFiscalYear(state.currentFiscalYear);
    }

    async function addTransaction(categoryId, payload) {
      const fy = calcFiscalYear(payload.date);
      if (fy === null) {
        alert("日付が不正です。");
        return;
      }
      await addDoc(collection(db, "transactions"), {
        categoryId,
        date: payload.date,
        shop: payload.shop,
        description: payload.description,
        amount: payload.amount,
        fiscalYear: fy
      });
      if (fy === state.currentFiscalYear) {
        await loadDataForFiscalYear(state.currentFiscalYear);
      }
    }

    async function updateTransaction(tranId, payload) {
      const fy = calcFiscalYear(payload.date);
      if (fy === null) {
        alert("日付が不正です。");
        return;
      }
      const ref = doc(db, "transactions", tranId);
      await updateDoc(ref, {
        date: payload.date,
        shop: payload.shop,
        description: payload.description,
        amount: payload.amount,
        fiscalYear: fy
      });
      await loadDataForFiscalYear(state.currentFiscalYear);
    }

    async function deleteTransaction(tranId, summaryText) {
      const ok = confirm(summaryText + "\n\nこの支出を削除しますか？");
      if (!ok) return;
      await deleteDoc(doc(db, "transactions", tranId));
      await loadDataForFiscalYear(state.currentFiscalYear);
    }

    // ==========================
    // 新年度作成：最新年度の費目をコピー
    // ==========================
    async function createNextFiscalYearFromLast() {
      if (!state.fiscalYears || state.fiscalYears.length === 0) {
        alert("まだ年度データがありません。先に現在の年度の費目を追加してください。");
        return;
      }

      const lastYear = Math.max(...state.fiscalYears);
      const newYear = lastYear + 1;

      const ok = confirm(
        `${lastYear}年度の費目をコピーして、${newYear}年度のデータを作成します。よろしいですか？`
      );
      if (!ok) return;

      const catRef = collection(db, "categories");
      const qLast = query(
        catRef,
        where("fiscalYear", "==", lastYear),
        orderBy("order", "asc")
      );
      const snap = await getDocs(qLast);

      if (snap.empty) {
        alert(`${lastYear}年度の費目データがありません。`);
        return;
      }

      const newCatPromises = [];
      let fallbackOrder = 1;
      snap.forEach((docSnap) => {
        const d = docSnap.data();
        newCatPromises.push(
          addDoc(collection(db, "categories"), {
            name: d.name,
            budget: d.budget ?? 0,
            order: typeof d.order === "number" ? d.order : fallbackOrder++,
            fiscalYear: newYear
          })
        );
      });

      await Promise.all(newCatPromises);

      if (!state.fiscalYears.includes(newYear)) {
        state.fiscalYears.push(newYear);
        state.fiscalYears.sort((a, b) => a - b);
      }

      state.currentFiscalYear = newYear;
      await loadDataForFiscalYear(newYear);
      renderYearSelect();
      alert(`${newYear}年度の費目データを作成しました。`);
    }

    // ==========================
    // CSV エクスポート（タブ区切り）
    // 日付は "YYYY/MM/DD" 形式
    // ==========================
    function buildTransactionsCsvForCurrentYear() {
      const header = ["費目", "日付", "店舗", "内容", "金額"];
      const lines = [];
      lines.push(header.join("\t"));

      const catMap = new Map();
      state.categories.forEach((c) => { catMap.set(c.id, c.name); });

      state.transactions.forEach((t) => {
        const catName = catMap.get(t.categoryId) || "";
        // 内部の日付は "YYYY-MM-DD" → CSVは "YYYY/MM/DD"
        const csvDate = t.date ? t.date.replace(/-/g, "/") : "";
        lines.push([
          catName,
          csvDate,
          t.shop || "",
          t.description || "",
          String(t.amount)
        ].join("\t"));
      });

      return lines.join("\r\n");
    }

    function downloadBlob(text, filename) {
      const blob = new Blob([text], { type: "text/tab-separated-values;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==========================
    // CSV インポート
    // フォーマット：タブ区切り
    // 1行目：費目<TAB>日付<TAB>店舗<TAB>内容<TAB>金額
    // 日付は "YYYY/MM/DD"
    // ==========================
    async function importTransactionsFromCsvText(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
      if (lines.length === 0) return;

      let startIndex = 0;
      const firstCols = lines[0].split("\t");
      const hasHeader = firstCols[0] === "費目";
      if (hasHeader) startIndex = 1;

      const fiscalYear = state.currentFiscalYear;

      // 費目名 → categoryId のマップ
      const catNameToId = new Map();
      state.categories.forEach((c) => {
        if (c.fiscalYear === fiscalYear) {
          catNameToId.set(c.name, c.id);
        }
      });

      let importedCount = 0;

      for (let i = startIndex; i < lines.length; i++) {
        const cols = lines[i].split("\t");
        if (cols.length < 5) continue;

        const [categoryName, dateCsv, shop, description, amountStr] = cols;
        if (!categoryName || !dateCsv) continue;

        // CSVは "YYYY/MM/DD" → 内部は "YYYY-MM-DD"
        const dateNorm = dateCsv.trim().replace(/\//g, "-");
        if (!dateNorm) continue;

        const fy = calcFiscalYear(dateNorm);
        if (fy !== fiscalYear) {
          // 他年度のものは今回スキップ
          continue;
        }

        const amount = parseInt(amountStr.replace(/,/g, ""), 10);
        if (isNaN(amount)) continue;

        let catId = catNameToId.get(categoryName);
        if (!catId) {
          // 現在の年度の費目になければ、予算0で新規作成
          const nowOrder = state.categories.length > 0
            ? Math.max(...state.categories.map((c) => c.order ?? 0)) + 1
            : 1;
          const newCatRef = await addDoc(collection(db, "categories"), {
            name: categoryName,
            budget: 0,
            order: nowOrder,
            fiscalYear
          });
          catId = newCatRef.id;
          catNameToId.set(categoryName, catId);
        }

        await addDoc(collection(db, "transactions"), {
          categoryId: catId,
          date: dateNorm,              // 内部保存は "YYYY-MM-DD"
          shop: shop || "",
          description: description || "",
          amount,
          fiscalYear
        });

        importedCount++;
      }

      await loadDataForFiscalYear(fiscalYear);
      alert(importedCount + "件の支出をインポートしました。");
    }

    // ==========================
    // 描画
    // ==========================
    function renderYearSelect() {
      const select = document.getElementById("fiscal-year-select");
      select.innerHTML = state.fiscalYears
        .map((y) => `<option value="${y}">${y}年度</option>`)
        .join("");
      if (state.currentFiscalYear != null) {
        select.value = String(state.currentFiscalYear);
      }
    }

    function renderSummary() {
      const { totalBudget, totalRemaining, percent } = calcTotal();
      document.getElementById("total-budget").textContent = formatYen(totalBudget);
      document.getElementById("total-remaining").textContent = formatYen(totalRemaining);
      document.getElementById("total-percent").textContent = percent.toFixed(1) + "%";
      document.getElementById("total-percent-bar").style.width = percent.toFixed(1) + "%";
    }

    function renderCategories() {
      const container = document.getElementById("categories-container");

      if (state.categories.length === 0) {
        container.innerHTML = `
          <div class="card">
            <div class="transaction-empty">
              選択した年度にはまだ費目データがありません。上のフォームまたは「新年度作成」ボタンから費目を追加してください。
            </div>
          </div>
        `;
        return;
      }

      const html = state.categories
        .map((cat) => {
          const { used, remaining, percent } = calcCategory(cat);
          const percentClass = getPercentBadgeClass(percent);
          const remainingClass = remaining < 0 ? "summary-item-value text-danger" : "summary-item-value";

          const transactions = state.transactions.filter((t) => t.categoryId === cat.id);

          const transactionsHtml =
            transactions.length === 0
              ? `<div class="transaction-empty">まだ支出の記録がありません。</div>`
              : transactions
                  .map((t) => {
                    const dateStr = formatDateForView(t.date);
                    const amountStr = t.amount.toLocaleString("ja-JP") + "円";
                    const shopStr = t.shop || "";
                    return `
                      <div class="transaction-item" data-tran-id="${t.id}" data-category-id="${cat.id}">
                        <div class="transaction-text">
                          <span class="tran-date">${dateStr}</span>
                          <span class="tran-amount">${amountStr}</span>
                          <span class="tran-desc">${t.description}</span>
                          <span class="tran-shop">${shopStr}</span>
                        </div>
                        <div>
                          <button type="button" class="btn-outline btn-xs edit-transaction">編集</button>
                          <button type="button" class="btn-outline btn-xs delete-transaction">削除</button>
                        </div>
                      </div>`;
                  })
                  .join("");

          return `
          <div class="category-card" data-category-id="${cat.id}">
            <div class="category-header">
              <div>
                <div class="category-name">● ${cat.name}</div>
                <div class="category-numbers">
                  <span>予算：${formatYen(cat.budget)}</span>
                  <span>残高：<span class="${remainingClass}">${formatYen(remaining)}</span></span>
                  <span>使用率：${percent.toFixed(1)}% <span class="${percentClass}">${percent.toFixed(1)}%</span></span>
                </div>
              </div>
              <div class="category-toolbar">
                <button type="button" class="btn-outline btn-xs edit-category">費目編集</button>
                <button type="button" class="btn-outline btn-xs delete-category">費目削除</button>
              </div>
            </div>
            <div class="percent-bar">
              <div class="percent-bar-fill" style="width:${percent.toFixed(1)}%"></div>
            </div>
            <div class="category-actions">
              <button class="btn-primary toggle-add-form">支出を記録</button>
            </div>
            <form class="add-form hidden add-transaction-form" data-edit-id="">
              <div class="add-form-row">
                <input type="date" name="date" required />
                <input type="number" name="amount" placeholder="金額" required min="1" />
                <input type="text" name="description" placeholder="内容（例：セーター）" required />
                <input type="text" name="shop" placeholder="店舗（任意）" />
              </div>
              <div class="add-form-actions">
                <button type="button" class="btn-outline cancel-add">キャンセル</button>
                <button type="submit" class="btn-primary submit-button">保存</button>
              </div>
            </form>
            <details>
              <summary>過去の支出</summary>
              <div class="transaction-list">
                ${transactionsHtml}
              </div>
            </details>
          </div>
        `;
        })
        .join("");

      container.innerHTML = html;
    }

    function renderAll() {
      renderYearSelect();
      renderSummary();
      renderCategories();
      attachCategoryAndTransactionEvents();
    }

    // ==========================
    // イベント
    // ==========================
    function attachGlobalEvents() {
      const yearSelect = document.getElementById("fiscal-year-select");
      yearSelect.addEventListener("change", async () => {
        const y = parseInt(yearSelect.value, 10);
        if (!isNaN(y)) {
          state.currentFiscalYear = y;
          await loadDataForFiscalYear(y);
        }
      });

      document.getElementById("reload-btn").addEventListener("click", async () => {
        if (state.currentFiscalYear != null) {
          await loadDataForFiscalYear(state.currentFiscalYear);
        }
      });

      // 新年度作成
      document.getElementById("new-year-btn").addEventListener("click", async () => {
        try {
          await createNextFiscalYearFromLast();
        } catch (e) {
          console.error(e);
          alert("新年度データ作成中にエラーが発生しました。");
        }
      });

      // 費目追加
      const addCatForm = document.getElementById("add-category-form");
      addCatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById("new-category-name");
        const budgetInput = document.getElementById("new-category-budget");
        const name = nameInput.value.trim();
        const budgetVal = parseInt(budgetInput.value, 10);
        if (!name) {
          alert("費目名を入力してください。");
          return;
        }
        if (isNaN(budgetVal) || budgetVal < 0) {
          alert("予算額は0以上の数値で入力してください。");
          return;
        }
        await addCategory(name, budgetVal);
        nameInput.value = "";
        budgetInput.value = "";
      });

      // CSVエクスポート
      document.getElementById("export-csv-btn").addEventListener("click", () => {
        if (!state.currentFiscalYear) {
          alert("年度が選択されていません。");
          return;
        }
        const csv = buildTransactionsCsvForCurrentYear();
        const filename = `transactions_${state.currentFiscalYear}.csv`;
        downloadBlob(csv, filename);
      });

      // CSVインポート
      const csvInput = document.getElementById("csv-file-input");
      document.getElementById("import-csv-btn").addEventListener("click", () => {
        csvInput.value = "";
        csvInput.click();
      });
      csvInput.addEventListener("change", () => {
        const file = csvInput.files && csvInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          const text = e.target.result;
          try {
            await importTransactionsFromCsvText(String(text));
          } catch (err) {
            console.error(err);
            alert("CSVインポート中にエラーが発生しました。");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    function attachCategoryAndTransactionEvents() {
      // 費目編集
      document.querySelectorAll(".category-card .edit-category").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const card = btn.closest(".category-card");
          const catId = card.dataset.categoryId;
          const cat = state.categories.find((c) => c.id === catId);
          if (!cat) return;

          const newName = prompt("費目名を編集", cat.name);
          if (newName === null) return;
          const trimmedName = newName.trim();
          if (!trimmedName) {
            alert("費目名は空にできません。");
            return;
          }
          const newBudgetStr = prompt("予算額を編集", String(cat.budget));
          if (newBudgetStr === null) return;
          const budgetVal = parseInt(newBudgetStr.replace(/,/g, ""), 10);
          if (isNaN(budgetVal) || budgetVal < 0) {
            alert("予算額は0以上の数値で入力してください。");
            return;
          }
          await updateCategory(catId, trimmedName, budgetVal);
        });
      });

      // 費目削除
      document.querySelectorAll(".category-card .delete-category").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const card = btn.closest(".category-card");
          const catId = card.dataset.categoryId;
          const cat = state.categories.find((c) => c.id === catId);
          if (!cat) return;
          await deleteCategoryAndTransactions(catId);
        });
      });

      // 「支出を記録」ボタン
      document.querySelectorAll(".category-card .toggle-add-form").forEach((btn) => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".category-card");
          const form = card.querySelector(".add-transaction-form");
          form.dataset.editId = "";
          form.querySelector(".submit-button").textContent = "保存";
          form.reset();
          form.classList.toggle("hidden");
        });
      });

      // 支出フォーム送信（新規 or 更新）
      document.querySelectorAll(".category-card .add-transaction-form").forEach((form) => {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const card = form.closest(".category-card");
          const catId = card.dataset.categoryId;
          const date = form.date.value;
          const amountVal = parseInt(form.amount.value, 10);
          const description = form.description.value.trim();
          const shop = form.shop.value.trim();
          if (!date || isNaN(amountVal) || amountVal <= 0 || !description) {
            alert("日付・金額・内容は必須です。");
            return;
          }
          const payload = {
            date,
            amount: amountVal,
            description,
            shop
          };
          const editId = form.dataset.editId;
          if (editId) {
            await updateTransaction(editId, payload);
          } else {
            await addTransaction(catId, payload);
          }
          form.reset();
          form.dataset.editId = "";
          form.classList.add("hidden");
        });

        const cancelBtn = form.querySelector(".cancel-add");
        cancelBtn.addEventListener("click", () => {
          form.reset();
          form.dataset.editId = "";
          form.classList.add("hidden");
        });
      });

      // 支出編集ボタン
      document.querySelectorAll(".category-card .edit-transaction").forEach((btn) => {
        btn.addEventListener("click", () => {
          const item = btn.closest(".transaction-item");
          const card = btn.closest(".category-card");
          const tranId = item.dataset.tranId;
          const tran = state.transactions.find((t) => t.id === tranId);
          if (!tran) return;
          const form = card.querySelector(".add-transaction-form");
          form.date.value = tran.date;
          form.amount.value = tran.amount;
          form.description.value = tran.description;
          form.shop.value = tran.shop;
          form.dataset.editId = tranId;
          form.querySelector(".submit-button").textContent = "更新";
          form.classList.remove("hidden");
        });
      });

      // 支出削除ボタン
      document.querySelectorAll(".category-card .delete-transaction").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const item = btn.closest(".transaction-item");
          const card = btn.closest(".category-card");
          const tranId = item.dataset.tranId;
          const catId = card.dataset.categoryId;
          const cat = state.categories.find((c) => c.id === catId);
          const tran = state.transactions.find((t) => t.id === tranId);
          if (!tran || !cat) return;
          const dateStr = formatDateForView(tran.date);
          const amountStr = tran.amount.toLocaleString("ja-JP") + "円";
          const shopStr = tran.shop ? `\n店舗：${tran.shop}` : "";
          const summary =
            `【費目】${cat.name}\n日付：${dateStr}\n金額：${amountStr}\n内容：${tran.description}${shopStr}`;
          await deleteTransaction(tranId, summary);
        });
      });
    }

    // ==========================
    // 起動
    // ==========================
    async function bootstrap() {
      try {
        await loadFiscalYearsFromCategories();
        attachGlobalEvents();
        await loadDataForFiscalYear(state.currentFiscalYear);
      } catch (e) {
        console.error("初期化エラー:", e);
        alert("初期化中にエラーが発生しました。Firebase設定やFirestoreルールを確認してください。");
      }
    }

    bootstrap();
  </script>
</body>
</html>
